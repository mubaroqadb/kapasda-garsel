<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAPASDA - Penilaian Kapasitas Daerah CDP Garut Selatan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .nav-tab.active { background-color: #2563eb; color: white; }
        .input-field { transition: all 0.2s; }
        .input-field:focus { transform: scale(1.02); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3); }
        .status-layak { background: linear-gradient(135deg, #10b981, #059669); }
        .status-tidak-layak { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .score-badge { min-width: 32px; text-align: center; }
        .indicator-group { border-left: 4px solid #3b82f6; }
        @media print { .no-print { display: none !important; } }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .nav-tab.hidden { display: none; }

    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="text-center">
            <i class="fas fa-spinner fa-spin text-5xl text-blue-600 mb-4"></i>
            <p class="text-gray-700 font-medium">Memuat aplikasi...</p>
        </div>
    </div>


    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-700 to-blue-900 text-white shadow-lg no-print">
        <div class="container mx-auto px-4 py-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center gap-3 mb-3 md:mb-0">
                    <i class="fas fa-chart-line text-3xl"></i>
                    <div>
                        <h1 class="text-xl md:text-2xl font-bold">KAPASDA</h1>
                        <p class="text-blue-200 text-sm">Penilaian Kapasitas Daerah CDP Kabupaten Garut Selatan</p>
                    </div>
                </div>
                <div class="flex items-center gap-3 text-sm">
                    <span id="userInfo" class="bg-blue-600 px-3 py-1 rounded-full"></span>
                    <span id="currentKecamatan" class="bg-blue-600 px-3 py-1 rounded-full"></span>
                    <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded-full transition">
                        <i class="fas fa-sign-out-alt mr-1"></i> Keluar
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-white shadow-md sticky top-0 z-50 no-print">
        <div class="container mx-auto px-4">
            <div class="flex overflow-x-auto">
                <button id="tabDashboard" onclick="showTab('dashboard')" class="nav-tab active flex-shrink-0 px-4 py-3 font-medium text-gray-600 hover:bg-blue-50 transition flex items-center gap-2">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </button>
                <button id="tabForm" onclick="showTab('form')" class="nav-tab flex-shrink-0 px-4 py-3 font-medium text-gray-600 hover:bg-blue-50 transition flex items-center gap-2">
                    <i class="fas fa-edit"></i> Form Input
                </button>
                <button id="tabRekap" onclick="showTab('rekap')" class="nav-tab flex-shrink-0 px-4 py-3 font-medium text-gray-600 hover:bg-blue-50 transition flex items-center gap-2">
                    <i class="fas fa-table"></i> Rekap Data
                </button>
                <button id="tabAdmin" onclick="showTab('admin')" class="nav-tab flex-shrink-0 px-4 py-3 font-medium text-gray-600 hover:bg-blue-50 transition flex items-center gap-2">
                    <i class="fas fa-cog"></i> Admin
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active fade-in">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <!-- Stats Cards -->
                <div class="bg-white rounded-xl shadow-md p-5 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Total Kecamatan</p>
                            <p id="statTotalKec" class="text-3xl font-bold text-blue-600">15</p>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-full">
                            <i class="fas fa-map-marker-alt text-blue-600 text-xl"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-5 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Sudah Input</p>
                            <p id="statSudahInput" class="text-3xl font-bold text-green-600">0</p>
                        </div>
                        <div class="bg-green-100 p-3 rounded-full">
                            <i class="fas fa-check-circle text-green-600 text-xl"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-5 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">LAYAK</p>
                            <p id="statLayak" class="text-3xl font-bold text-emerald-600">0</p>
                        </div>
                        <div class="bg-emerald-100 p-3 rounded-full">
                            <i class="fas fa-thumbs-up text-emerald-600 text-xl"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-5 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">TIDAK LAYAK</p>
                            <p id="statTidakLayak" class="text-3xl font-bold text-red-600">0</p>
                        </div>
                        <div class="bg-red-100 p-3 rounded-full">
                            <i class="fas fa-thumbs-down text-red-600 text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-white rounded-xl shadow-md p-5">
                    <h3 class="font-semibold text-gray-700 mb-4"><i class="fas fa-chart-bar mr-2"></i>Perbandingan Nilai per Kecamatan</h3>
                    <canvas id="chartKecamatan"></canvas>
                </div>
                <div class="bg-white rounded-xl shadow-md p-5">
                    <h3 class="font-semibold text-gray-700 mb-4"><i class="fas fa-chart-pie mr-2"></i>Status Kelayakan</h3>
                    <canvas id="chartKelayakan"></canvas>
                </div>
            </div>

            <!-- Kecamatan Cards -->
            <div class="bg-white rounded-xl shadow-md p-5">
                <h3 class="font-semibold text-gray-700 mb-4"><i class="fas fa-list mr-2"></i>Status per Kecamatan</h3>
                <div id="kecamatanCards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4"></div>
            </div>
        </div>

        <!-- Form Input Tab -->
        <div id="form" class="tab-content fade-in">
            <div class="bg-white rounded-xl shadow-md p-5 mb-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                    <div class="flex-1 w-full md:w-auto">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Kecamatan</label>
                        <select id="selectKecamatan" onchange="loadKecamatanData()" class="w-full md:w-64 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </select>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="saveData()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition flex items-center gap-2">
                            <i class="fas fa-save"></i> Simpan
                        </button>
                        <button onclick="resetForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition flex items-center gap-2">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                    </div>
                </div>

                <!-- Status Display -->
                <div id="statusDisplay" class="mb-6 p-4 rounded-lg bg-gray-100">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                        <div class="text-center md:text-left">
                            <p class="text-gray-600 text-sm">Total Nilai</p>
                            <p id="totalNilai" class="text-4xl font-bold text-blue-600">0</p>
                        </div>
                        <div class="text-center">
                            <p class="text-gray-600 text-sm">Total Bobot</p>
                            <p id="totalBobot" class="text-2xl font-semibold text-gray-700">100</p>
                        </div>
                        <div id="statusKelayakan" class="px-6 py-3 rounded-lg text-white font-bold text-lg status-tidak-layak">
                            TIDAK LAYAK
                        </div>
                    </div>
                </div>

                <!-- Form Indicators -->
                <div id="formIndicators" class="space-y-4">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Rekap Tab -->
        <div id="rekap" class="tab-content fade-in">
            <div class="bg-white rounded-xl shadow-md p-5 mb-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                    <h3 class="font-semibold text-gray-700"><i class="fas fa-table mr-2"></i>Rekap Data Seluruh Kecamatan</h3>
                    <div class="flex gap-2">
                        <button onclick="exportExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition flex items-center gap-2">
                            <i class="fas fa-file-excel"></i> Export Excel
                        </button>
                        <label class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition flex items-center gap-2 cursor-pointer">
                            <i class="fas fa-file-import"></i> Import Excel
                            <input type="file" accept=".xlsx,.xls" onchange="importExcel(event)" class="hidden">
                        </label>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table id="rekapTable" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kecamatan</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Total Nilai</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Terakhir Update</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider no-print">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="rekapTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Admin Tab -->
        <div id="admin" class="tab-content fade-in">
            <div class="bg-white rounded-xl shadow-md p-5 mb-6">
                <h3 class="font-semibold text-gray-700 mb-4"><i class="fas fa-database mr-2"></i>Edit Data Pembanding</h3>
                <p class="text-gray-500 text-sm mb-4">Data pembanding digunakan sebagai acuan perhitungan rasio dan skor.</p>
                
                <div id="adminDataPembanding" class="space-y-4">
                    <!-- Will be populated by JavaScript -->
                </div>

                <div class="mt-6 flex gap-2">
                    <button onclick="saveDataPembanding()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition flex items-center gap-2">
                        <i class="fas fa-save"></i> Simpan Data Pembanding
                    </button>
                    <button onclick="resetDataPembanding()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition flex items-center gap-2">
                        <i class="fas fa-undo"></i> Reset ke Default
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-5">
                <h3 class="font-semibold text-gray-700 mb-4"><i class="fas fa-trash-alt mr-2"></i>Kelola Data</h3>
                <div class="flex gap-2">
                    <button onclick="clearAllData()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition flex items-center gap-2">
                        <i class="fas fa-trash"></i> Hapus Semua Data Kecamatan
                    </button>
                    <button onclick="deleteIncorrectRecords()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg transition flex items-center gap-2">
                        <i class="fas fa-broom"></i> Bersihkan Data Salah
                    </button>
                    <button onclick="exportAllData()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition flex items-center gap-2">
                        <i class="fas fa-download"></i> Backup Semua Data
                    </button>
                    <label class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition flex items-center gap-2 cursor-pointer">
                        <i class="fas fa-upload"></i> Restore Data
                        <input type="file" accept=".json" onchange="importAllData(event)" class="hidden">
                    </label>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        <span id="toastMessage"></span>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-gray-400 py-4 mt-8 no-print">
        <div class="container mx-auto px-4 text-center text-sm">
            <p>KAPASDA - Sistem Penilaian Kapasitas Daerah CDP Kabupaten Garut Selatan</p>
            <p class="mt-1">Â© 2025 Unfari Research Team - Dikembangkan untuk Pemerintah Kabupaten Garut</p>
        </div>
    </footer>

    <script>
        // ==================== SUPABASE CONFIGURATION ====================
        const SUPABASE_URL = 'https://vedwbuflttjrnhueymer.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZlZHdidWZsdHRqcm5odWV5bWVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MDY3MDIsImV4cCI6MjA4MDE4MjcwMn0.qqo9_4u8rRRDRh74Jq-PGyc-0md_fO5TgQl9Wap44kE';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Global state for auth
        let currentUser = null;
        let currentProfile = null;
        let userRole = null;
        let userKecamatanId = null;
        let userKecamatanName = null;

        // ==================== AUTH & PROFILE ====================
        async function checkAuth() {
            try {
                const { data: { session }, error } = await supabaseClient.auth.getSession();
                
                if (error) throw error;
                
                if (!session) {
                    window.location.href = 'login.html';
                    return false;
                }
                
                currentUser = session.user;
                
                // Load user profile
                const { data: profile, error: profileError } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();
                
                if (profileError) throw profileError;
                
                currentProfile = profile;
                userRole = profile.role;
                userKecamatanId = profile.kecamatan_id;
                
                // Load kecamatan name if applicable
                if (userKecamatanId) {
                    const { data: kecData, error: kecError } = await supabaseClient
                        .from('kecamatan')
                        .select('nama')
                        .eq('id', userKecamatanId)
                        .single();
                    
                    if (!kecError && kecData) {
                        userKecamatanName = kecData.nama;
                    }
                }
                
                // Update UI with user info
                document.getElementById('userInfo').textContent = 
                    `${profile.nama || profile.email} (${userRole.toUpperCase()})`;
                
                // Configure UI based on role
                configureUIByRole();
                
                return true;
            } catch (error) {
                console.error('Auth error:', error);
                alert('Error loading user data: ' + error.message);
                window.location.href = 'login.html';
                return false;
            }
        }

        function configureUIByRole() {
            const tabDashboard = document.getElementById('tabDashboard');
            const tabForm = document.getElementById('tabForm');
            const tabRekap = document.getElementById('tabRekap');
            const tabAdmin = document.getElementById('tabAdmin');
            
            if (userRole === 'admin') {
                // Admin can see all tabs
                tabDashboard.classList.remove('hidden');
                tabForm.classList.remove('hidden');
                tabRekap.classList.remove('hidden');
                tabAdmin.classList.remove('hidden');
            } else if (userRole === 'kecamatan') {
                // Kecamatan can see dashboard, form, rekap (filtered)
                tabDashboard.classList.remove('hidden');
                tabForm.classList.remove('hidden');
                tabRekap.classList.remove('hidden');
                tabAdmin.classList.add('hidden');
            }
        }

        async function logout() {
            if (!confirm('Keluar dari aplikasi?')) return;
            
            try {
                await supabaseClient.auth.signOut();
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Logout error:', error);
                alert('Error during logout: ' + error.message);
            }
        }

        // ==================== DATA CONFIGURATION ====================
        const KECAMATAN_LIST = [
            'Cibalong', 'Pakenjeng', 'Cisewu', 'Cikelet', 'Cisompet',
            'Bungbulang', 'Caringin', 'Mekarmukti', 'Pamulihan', 'Talegong',
            'Banjarwangi', 'Singajaya', 'Cihurip', 'Pendeuy', 'Pameungpeuk'
        ];

        const BATAS_LAYAK = 400;

        // Indicator configurations with formulas
        const INDICATORS = [
            {
                no: 1, nama: 'Lokasi Ibukota',
                subs: [
                    { id: '1.1', nama: 'Rasio ketimpangan jarak (batas terdekat/terjauh dengan ibukota)', 
                      pembanding: 55, bobot: 2, type: 'ratio',
                      skorFunc: (r) => r === '' ? 0 : r <= 0.2 ? 1 : r <= 0.4 ? 2 : r <= 0.6 ? 3 : r <= 0.8 ? 4 : 5 },
                    { id: '1.2', nama: 'Ketersediaan lahan pusat pemerintahan (ha)', 
                      pembanding: 50, bobot: 2, type: 'direct',
                      skorFunc: (v) => v === '' ? 0 : v <= 30 ? 1 : v <= 40 ? 2 : v <= 50 ? 3 : v <= 60 ? 4 : 5 }
                ]
            },
            {
                no: 2, nama: 'Hidrografi',
                subs: [
                    { id: '2.1', nama: 'Potensi air permukaan dan air tanah (liter/detik)', 
                      pembanding: 4000, bobot: 1, type: 'direct',
                      skorFunc: (v) => v === '' ? 0 : v <= 1000 ? 1 : v <= 2000 ? 2 : v <= 3000 ? 3 : v <= 4000 ? 4 : 5 },
                    { id: '2.2', nama: 'Ketersediaan air baku untuk penduduk & ekonomi (%)', 
                      pembanding: 40, bobot: 1, type: 'direct',
                      skorFunc: (v) => v === '' ? 0 : v <= 10 ? 1 : v <= 20 ? 2 : v <= 30 ? 3 : v <= 40 ? 4 : 5 }
                ]
            },
            {
                no: 3, nama: 'Kerawanan Bencana',
                subs: [
                    { id: '3.1', nama: 'Indeks Risiko Bencana Indonesia (IRBI) - Kab. Induk', 
                      pembanding: 72, bobot: 1, type: 'direct',
                      skorFunc: (v) => v === '' ? 0 : v < 72 ? 5 : v <= 144 ? 3 : 1 },
                    { id: '3.2', nama: 'Jumlah kejadian bencana alam 10 tahun terakhir (kali)', 
                      pembanding: 200, bobot: 2, type: 'direct',
                      skorFunc: (v) => v === '' ? 0 : v === 0 ? 5 : v <= 5 ? 4 : v <= 10 ? 3 : v <= 15 ? 2 : 1 }
                ]
            },
            {
                no: 4, nama: 'Kualitas SDM',
                subs: [
                    { id: '4.1', nama: 'Rasio Angka Lama Sekolah (RLS) CDP vs Pulau Jawa', 
                      pembanding: 8.61, bobot: 4, type: 'ratio',
                      skorFunc: (r) => r === '' ? 0 : r >= 1 ? 5 : r >= 0.9 ? 4 : r >= 0.8 ? 3 : r >= 0.7 ? 2 : 1 },
                    { id: '4.2', nama: 'Rasio APK Pendidikan Menengah Atas vs Pulau Jawa', 
                      pembanding: 82.43, bobot: 4, type: 'ratio',
                      skorFunc: (r) => r === '' ? 0 : r >= 1 ? 5 : r >= 0.9 ? 4 : r >= 0.8 ? 3 : r >= 0.7 ? 2 : 1 },
                    { id: '4.3', nama: 'Rasio APK Pendidikan Dasar vs Pulau Jawa', 
                      pembanding: 109.52, bobot: 4, type: 'ratio',
                      skorFunc: (r) => r === '' ? 0 : r >= 1 ? 5 : r >= 0.9 ? 4 : r >= 0.8 ? 3 : r >= 0.7 ? 2 : 1 }
                ]
            },
            {
                no: 5, nama: 'Distribusi Penduduk',
                subs: [
                    { id: '5.1', nama: 'Rasio kepadatan penduduk CDP vs rata-rata Pulau Jawa', 
                      pembanding: 1117, bobot: 3, type: 'ratio',
                      skorFunc: (r) => r === '' ? 0 : r >= 1 ? 5 : r >= 0.9 ? 4 : r >= 0.8 ? 3 : r >= 0.7 ? 2 : 1 }
                ]
            },
            {
                no: 6, nama: 'Tindakan Kriminal Umum',
                subs: [
                    { id: '6.1', nama: 'Rasio kriminal per 10.000 penduduk CDP vs Pulau Jawa', 
                      pembanding: 5.2, bobot: 2, type: 'ratio',
                      skorFunc: (r) => r === '' ? 0 : r >= 1 ? 1 : r >= 0.9 ? 2 : r >= 0.8 ? 3 : r >= 0.7 ? 4 : 5 }
                ]
            },
            {
                no: 7, nama: 'Konflik Sosial',
                subs: [
                    { id: '7.1', nama: 'Jumlah konflik sosial di CDP (kali)', 
                      pembanding: 2, bobot: 2, type: 'direct',
                      skorFunc: (v) => v === '' ? 0 : v === 0 ? 5 : v <= 5 ? 4 : v <= 10 ? 3 : v <= 15 ? 2 : 1 }
                ]
            },
            {
                no: 8, nama: 'Partisipasi Masyarakat dalam Pemilu',
                subs: [
                    { id: '8.1', nama: 'Persentase partisipasi pemilih (%)', 
                      pembanding: 70, bobot: 3, type: 'direct',
                      skorFunc: (v) => v === '' ? 0 : v > 70 ? 5 : v >= 60 ? 4 : v >= 50 ? 3 : v >= 40 ? 2 : 1 }
                ]
            },
            {
                no: 9, nama: 'Kohesivitas Sosial',
                subs: [
                    { id: '9.1', nama: 'Jumlah etnik/subetnik di CDP', 
                      pembanding: 1, bobot: 2, type: 'direct',
                      skorFunc: (v) => v === '' ? 0 : v <= 1 ? 5 : v <= 3 ? 4 : v <= 5 ? 3 : v <= 7 ? 2 : 1 }
                ]
            },
            {
                no: 10, nama: 'Organisasi Kemasyarakatan',
                subs: [
                    { id: '10.1', nama: 'Jumlah ormas terdaftar di CDP', 
                      pembanding: 40, bobot: 3, type: 'direct',
                      skorFunc: (v) => v === '' ? 0 : v > 40 ? 5 : v >= 31 ? 4 : v >= 21 ? 3 : v >= 11 ? 2 : 1 }
                ]
            },
            {
                no: 11, nama: 'Pertumbuhan Ekonomi',
                subs: [
                    { id: '11.1', nama: 'Rasio pertumbuhan ekonomi 5 tahun CDP vs Pulau Jawa', 
                      pembanding: 5.43, bobot: 3, type: 'ratio',
                      skorFunc: (r) => r === '' ? 0 : r >= 1 ? 5 : r >= 0.9 ? 4 : r >= 0.8 ? 3 : r >= 0.7 ? 2 : 1 },
                    { id: '11.2', nama: 'Rasio pendapatan perkapita CDP vs Pulau Jawa (Rp)', 
                      pembanding: 45000000, bobot: 3, type: 'ratio',
                      skorFunc: (r) => r === '' ? 0 : r >= 1 ? 5 : r >= 0.9 ? 4 : r >= 0.8 ? 3 : r >= 0.7 ? 2 : 1 },
                    { id: '11.3', nama: 'Rasio IPM CDP vs Pulau Jawa', 
                      pembanding: 74.24, bobot: 3, type: 'ratio',
                      skorFunc: (r) => r === '' ? 0 : r >= 1 ? 5 : r >= 0.9 ? 4 : r >= 0.8 ? 3 : r >= 0.7 ? 2 : 1 },
                    { id: '11.4', nama: 'Rasio angka kemiskinan CDP vs Pulau Jawa (%)', 
                      pembanding: 7.83, bobot: 3, type: 'ratio',
                      skorFunc: (r) => r === '' ? 0 : r < 0.7 ? 5 : r < 0.8 ? 4 : r < 0.9 ? 3 : r < 1 ? 2 : 1 }
                ]
            },
            {
                no: 12, nama: 'Potensi Unggulan Daerah',
                subs: [
                    { id: '12.1', nama: 'Rasio PDRB sektor pertanian perkapita vs PDB nasional', 
                      pembanding: 1, bobot: 1, type: 'direct',
                      skorFunc: (v) => v === '' ? 0 : v >= 1 ? 5 : v >= 0.9 ? 4 : v >= 0.8 ? 3 : v >= 0.7 ? 2 : 1 },
                    { id: '12.2', nama: 'Rasio PDRB sektor industri perkapita vs rata-rata Pulau Jawa', 
                      pembanding: 1, bobot: 1, type: 'direct',
                      skorFunc: (v) => v === '' ? 0 : v >= 1 ? 5 : v >= 0.9 ? 4 : v >= 0.8 ? 3 : v >= 0.7 ? 2 : 1 },
                    { id: '12.3', nama: 'Rasio PDRB sektor perdagangan, hotel, restoran perkapita', 
                      pembanding: 1, bobot: 2, type: 'direct',
                      skorFunc: (v) => v === '' ? 0 : v >= 1 ? 5 : v >= 0.9 ? 4 : v >= 0.8 ? 3 : v >= 0.7 ? 2 : 1 },
                    { id: '12.4', nama: 'Rasio PDRB sektor pengangkutan & komunikasi perkapita', 
                      pembanding: 1, bobot: 1, type: 'direct',
                      skorFunc: (v) => v === '' ? 0 : v >= 1 ? 5 : v >= 0.9 ? 4 : v >= 0.8 ? 3 : v >= 0.7 ? 2 : 1 },
                    { id: '12.5', nama: 'Rasio PDRB sektor keuangan & persewaan perkapita', 
                      pembanding: 1, bobot: 2, type: 'direct',
                      skorFunc: (v) => v === '' ? 0 : v >= 1 ? 5 : v >= 0.9 ? 4 : v >= 0.8 ? 3 : v >= 0.7 ? 2 : 1 },
                    { id: '12.6', nama: 'Rasio PDRB sektor jasa perkapita', 
                      pembanding: 1, bobot: 2, type: 'direct',
                      skorFunc: (v) => v === '' ? 0 : v >= 1 ? 5 : v >= 0.9 ? 4 : v >= 0.8 ? 3 : v >= 0.7 ? 2 : 1 }
                ]
            },
            {
                no: 13, nama: 'Kapasitas PAD Induk',
                subs: [
                    { id: '13.1', nama: 'Rasio PAD induk terhadap total pendapatan daerah induk', 
                      pembanding: 4780000000000, bobot: 5, type: 'ratio',
                      skorFunc: (r) => r === '' ? 0 : r >= 1 ? 5 : r >= 0.9 ? 4 : r >= 0.8 ? 3 : r >= 0.7 ? 2 : 1 }
                ]
            },
            {
                no: 14, nama: 'Potensi PAD CDP',
                subs: [
                    { id: '14.1', nama: 'Rasio PAD CDP terhadap total PAD induk', 
                      pembanding: 538000000000, bobot: 8, type: 'ratio',
                      skorFunc: (r) => r === '' ? 0 : r >= 1 ? 1 : r >= 0.9 ? 2 : r >= 0.8 ? 3 : r >= 0.7 ? 4 : 5 }
                ]
            },
            {
                no: 15, nama: 'Pengelolaan Keuangan & Aset',
                subs: [
                    { id: '15.1', nama: 'Jumlah opini WTP BPK dalam 5 tahun terakhir (1-5)', 
                      pembanding: 5, bobot: 4, type: 'direct',
                      skorFunc: (v) => v === '' ? 0 : v >= 5 ? 5 : v >= 4 ? 4 : v >= 3 ? 3 : v >= 2 ? 2 : 1 }
                ]
            },
            {
                no: 16, nama: 'Aksesibilitas Pelayanan Dasar Pendidikan',
                subs: [
                    { id: '16.1', nama: 'Rata-rata jumlah murid per ruang belajar SD', 
                      pembanding: 28, bobot: 2, type: 'direct',
                      skorFunc: (v) => v === '' ? 0 : v <= 32 ? 1 : v <= 35 ? 2 : v <= 39 ? 3 : v <= 42 ? 4 : 5 },
                    { id: '16.2', nama: 'Rata-rata jumlah murid per ruang belajar SMP', 
                      pembanding: 32, bobot: 2, type: 'direct',
                      skorFunc: (v) => v === '' ? 0 : v <= 32 ? 1 : v <= 35 ? 2 : v <= 39 ? 3 : v <= 42 ? 4 : 5 },
                    { id: '16.3', nama: 'Rata-rata jumlah murid per ruang belajar SMA/SMK', 
                      pembanding: 36, bobot: 1, type: 'direct',
                      skorFunc: (v) => v === '' ? 0 : v <= 32 ? 1 : v <= 35 ? 2 : v <= 39 ? 3 : v <= 42 ? 4 : 5 }
                ]
            },
            {
                no: 17, nama: 'Aksesibilitas Pelayanan Dasar Kesehatan',
                subs: [
                    { id: '17.1', nama: 'Rasio penduduk per dokter (jumlah penduduk/dokter)', 
                      pembanding: 2500, bobot: 3, type: 'ratio',
                      skorFunc: (r) => r === '' ? 0 : r < 2500 ? 1 : r < 3000 ? 2 : r < 3500 ? 3 : r < 4000 ? 4 : 5 },
                    { id: '17.2', nama: 'Rasio penduduk per tempat tidur RS/Puskesmas (penduduk/TT)', 
                      pembanding: 1000, bobot: 2, type: 'ratio',
                      skorFunc: (r) => r === '' ? 0 : r <= 1000 ? 1 : r <= 1500 ? 2 : r <= 2000 ? 3 : r <= 2500 ? 4 : 5 }
                ]
            },
            {
                no: 18, nama: 'Aksesibilitas Pelayanan Dasar Infrastruktur',
                subs: [
                    { id: '18.1', nama: 'Rasio (panjang jalan/luas) CDP vs rata-rata Pulau Jawa', 
                      pembanding: 2850, bobot: 10, type: 'ratio',
                      skorFunc: (r) => r === '' ? 0 : r >= 0.8 ? 1 : r >= 0.6 ? 2 : r >= 0.41 ? 3 : r >= 0.21 ? 4 : 5 }
                ]
            },
            {
                no: 19, nama: 'Jumlah Pegawai ASN di Daerah Induk',
                subs: [
                    { id: '19.1', nama: 'Rasio ASN/penduduk induk vs rata-rata Pulau Jawa', 
                      pembanding: 2680000, bobot: 2, type: 'ratio',
                      skorFunc: (r) => r === '' ? 0 : r >= 0.8 ? 1 : r >= 0.6 ? 2 : r >= 0.41 ? 3 : r >= 0.21 ? 4 : 5 },
                    { id: '19.2', nama: 'Rasio ASN CDP terhadap ASN induk', 
                      pembanding: 12500, bobot: 2, type: 'ratio',
                      skorFunc: (r) => r === '' ? 0 : r >= 0.8 ? 1 : r >= 0.6 ? 2 : r >= 0.41 ? 3 : r >= 0.21 ? 4 : 5 }
                ]
            },
            {
                no: 20, nama: 'Rancangan RTRW Daerah Persiapan',
                subs: [
                    { id: '20.1', nama: 'Ketersediaan dokumen RTRW CDP (Skor 1, 3, atau 5)', 
                      pembanding: 3, bobot: 2, type: 'direct',
                      skorFunc: (v) => v === '' ? 0 : v >= 5 ? 5 : v >= 3 ? 3 : 1 }
                ]
            }
        ];

        // ==================== STATE MANAGEMENT ====================
        let dataPembanding = {};
        let allKecamatanData = {};
        let chartKecamatan = null;
        let chartKelayakan = null;

        // ==================== INITIALIZATION ====================
        async function init() {
            // Check authentication first
            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) return;
            
            // Load data from Supabase
            await loadDataPembanding();
            await loadAllKecamatanData();
            
            populateKecamatanSelect();
            renderFormIndicators();
            renderAdminDataPembanding();
            updateDashboard();
            updateRekapTable();
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            // Load first kecamatan based on role
            if (userRole === 'kecamatan' && userKecamatanName) {
                // For kecamatan user, load their kecamatan
                document.getElementById('selectKecamatan').value = userKecamatanName;
                loadKecamatanData();
            } else if (KECAMATAN_LIST.length > 0) {
                // For admin, load first kecamatan
                document.getElementById('selectKecamatan').value = KECAMATAN_LIST[0];
                loadKecamatanData();
            }
            
            // Hide loading overlay
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
                hour: '2-digit', minute: '2-digit'
            };
            const dateTimeElement = document.getElementById('currentDateTime');
            if (dateTimeElement) {
                dateTimeElement.textContent = now.toLocaleDateString('id-ID', options);
            }
        }

        // ==================== DATA PEMBANDING MANAGEMENT ====================
        async function loadDataPembanding() {
            try {
                const { data, error } = await supabaseClient
                    .from('data_pembanding')
                    .select('*');
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    // Load from database
                    data.forEach(item => {
                        dataPembanding[item.subindikator_kode] = item.nilai_max;
                    });
                } else {
                    // Initialize with default values
                    INDICATORS.forEach(ind => {
                        ind.subs.forEach(sub => {
                            dataPembanding[sub.id] = sub.pembanding;
                        });
                    });
                }
            } catch (error) {
                console.error('Error loading data pembanding:', error);
                // Fallback to default values
                INDICATORS.forEach(ind => {
                    ind.subs.forEach(sub => {
                        dataPembanding[sub.id] = sub.pembanding;
                    });
                });
            }
        }

        async function saveDataPembanding() {
            if (userRole !== 'admin') {
                showToast('Hanya admin yang dapat mengubah data pembanding!', 'error');
                return;
            }
            
            try {
                const updates = [];
                INDICATORS.forEach(ind => {
                    ind.subs.forEach(sub => {
                        const input = document.getElementById(`admin_${sub.id}`);
                        if (input) {
                            const newValue = parseFloat(input.value) || sub.pembanding;
                            dataPembanding[sub.id] = newValue;
                            updates.push({
                                subindikator_kode: sub.id,
                                subindikator_nama: sub.nama,
                                nilai_max: newValue,
                                rumus: sub.type
                            });
                        }
                    });
                });
                
                // Upsert to database
                const { error } = await supabaseClient
                    .from('data_pembanding')
                    .upsert(updates, { onConflict: 'subindikator_kode' });
                
                if (error) throw error;
                
                showToast('Data pembanding berhasil disimpan!');
                
                // Recalculate all kecamatan
                await recalculateAllKecamatan();
            } catch (error) {
                console.error('Error saving data pembanding:', error);
                showToast('Gagal menyimpan data pembanding!', 'error');
            }
        }

        async function resetDataPembanding() {
            if (!confirm('Reset semua data pembanding ke nilai default?')) return;
            
            if (userRole !== 'admin') {
                showToast('Hanya admin yang dapat mereset data pembanding!', 'error');
                return;
            }
            
            try {
                INDICATORS.forEach(ind => {
                    ind.subs.forEach(sub => {
                        dataPembanding[sub.id] = sub.pembanding;
                    });
                });
                
                // Save to database
                const updates = [];
                INDICATORS.forEach(ind => {
                    ind.subs.forEach(sub => {
                        updates.push({
                            subindikator_kode: sub.id,
                            subindikator_nama: sub.nama,
                            nilai_max: sub.pembanding,
                            rumus: sub.type
                        });
                    });
                });
                
                const { error } = await supabaseClient
                    .from('data_pembanding')
                    .upsert(updates, { onConflict: 'subindikator_kode' });
                
                if (error) throw error;
                
                renderAdminDataPembanding();
                await recalculateAllKecamatan();
                showToast('Data pembanding berhasil direset!');
            } catch (error) {
                console.error('Error resetting data pembanding:', error);
                showToast('Gagal mereset data pembanding!', 'error');
            }
        }

        async function recalculateAllKecamatan() {
            for (const kec of KECAMATAN_LIST) {
                if (allKecamatanData[kec] && allKecamatanData[kec].inputs) {
                    try {
                        await calculateAndSave(kec, allKecamatanData[kec].inputs);
                    } catch (error) {
                        console.error(`Error recalculating ${kec}:`, error);
                    }
                }
            }
            await loadAllKecamatanData();
            updateDashboard();
            updateRekapTable();
            loadKecamatanData();
        }

        // ==================== KECAMATAN DATA MANAGEMENT ====================
        async function loadAllKecamatanData() {
            try {
                // Get kecamatan mapping first
                const { data: kecamatanList, error: kecError } = await supabaseClient
                    .from('kecamatan')
                    .select('id, nama');
                
                if (kecError) throw kecError;
                
                const kecamatanMap = {};
                kecamatanList.forEach(k => {
                    kecamatanMap[k.id] = k.nama;
                });
                
                // Build query based on role
                let query = supabaseClient
                    .from('penilaian')
                    .select('*')
                    .eq('status', 'final');
                
                if (userRole === 'kecamatan' && userKecamatanId) {
                    query = query.eq('kecamatan_id', userKecamatanId);
                }
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                // Convert to allKecamatanData format
                allKecamatanData = {};
                if (data) {
                    data.forEach(item => {
                        const kecamatanName = kecamatanMap[item.kecamatan_id];
                        if (kecamatanName && item.data) {
                            const jsonData = item.data;
                            allKecamatanData[kecamatanName] = {
                                inputs: jsonData.inputs || {},
                                calculations: jsonData.calculations || {},
                                totalNilai: item.total_nilai || 0,
                                status: item.total_nilai >= BATAS_LAYAK ? 'LAYAK' : 'TIDAK LAYAK',
                                lastUpdate: item.updated_at
                            };
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading kecamatan data:', error);
                allKecamatanData = {};
            }
        }

        async function saveAllKecamatanData() {
            // This function is deprecated in favor of direct save in calculateAndSave
            // Kept for compatibility
        }

        async function calculateAndSave(kecamatan, inputs) {
            // 1. Check Authentication
            if (!currentUser) {
                // Try to re-check auth silently
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (session) {
                    currentUser = session.user;
                } else {
                    throw new Error("Sesi login berakhir. Harap login kembali.");
                }
            }

            let totalNilai = 0;
            const calculations = {};
            
            INDICATORS.forEach(ind => {
                ind.subs.forEach(sub => {
                    const inputValue = inputs[sub.id];
                    const pembanding = dataPembanding[sub.id] || sub.pembanding;
                    
                    let rasio = 0;
                    if (sub.type === 'ratio') {
                        rasio = pembanding > 0 ? (inputValue / pembanding) : 0;
                    } else {
                        rasio = inputValue;
                    }
                    
                    const skor = inputValue === 0 ? 0 : sub.skorFunc(rasio);
                    const nilai = skor * sub.bobot;
                    totalNilai += nilai;
                    
                    calculations[sub.id] = {
                        input: inputValue,
                        pembanding: pembanding,
                        rasio: rasio,
                        skor: skor,
                        bobot: sub.bobot,
                        nilai: nilai
                    };
                });
            });
            
            const status = totalNilai >= BATAS_LAYAK ? 'LAYAK' : 'TIDAK LAYAK';
            
            // Validate inputs
            if (!kecamatan) throw new Error("Nama kecamatan tidak valid");

            allKecamatanData[kecamatan] = {
                inputs: inputs,
                calculations: calculations,
                totalNilai: totalNilai,
                status: status,
                lastUpdate: new Date().toISOString()
            };
            
            // Save to Supabase
            try {
                // Get kecamatan ID with fuzzy matching
                const { data: kecData, error: kecError } = await supabaseClient
                    .from('kecamatan')
                    .select('id')
                    .ilike('nama', kecamatan.trim()) // Use case-insensitive match
                    .maybeSingle(); 
                
                if (kecError) {
                    console.error("Supabase Error (Kecamatan Lookup):", kecError);
                    throw new Error("Gagal mencari data kecamatan: " + kecError.message);
                }

                if (!kecData) {
                    console.error(`Kecamatan not found: '${kecamatan}'`);
                    throw new Error(`Data kecamatan '${kecamatan}' tidak ditemukan di database.`);
                }
                
                const penilaianData = {
                    kecamatan_id: kecData.id,
                    user_id: currentUser.id,
                    data: {
                        inputs: inputs,
                        calculations: calculations
                    },
                    total_nilai: totalNilai,
                    status: 'final'
                };
                
                // Upsert to database
                const { error } = await supabaseClient
                    .from('penilaian')
                    .upsert(penilaianData, {
                        onConflict: 'kecamatan_id'
                    });
                
                if (error) {
                    console.error("Supabase Upsert Error:", error);
                    throw new Error("Gagal menyimpan ke database: " + error.message);
                }

            } catch (error) {
                console.error('Error saving to Supabase:', error);
                throw error; // Re-throw to be caught by saveData
            }
            
            return { totalNilai, status };
        }

        // ==================== UI POPULATION ====================
        function populateKecamatanSelect() {
            const select = document.getElementById('selectKecamatan');
            let kecamatanOptions = KECAMATAN_LIST;
            
            // Filter based on role
            if (userRole === 'kecamatan' && userKecamatanName) {
                kecamatanOptions = [userKecamatanName];
            }
            
            select.innerHTML = kecamatanOptions.map(k => 
                `<option value="${k}">${k}</option>`
            ).join('');
            
            // Disable select for non-admin users
            if (userRole !== 'admin') {
                select.disabled = true;
                select.classList.add('bg-gray-100', 'cursor-not-allowed');
            }
        }

        function renderFormIndicators() {
            const container = document.getElementById('formIndicators');
            let html = '';
            
            INDICATORS.forEach(ind => {
                html += `
                    <div class="indicator-group bg-gray-50 rounded-lg p-4 pl-6">
                        <h4 class="font-semibold text-gray-800 mb-3">
                            <span class="bg-blue-600 text-white text-sm px-2 py-1 rounded mr-2">${ind.no}</span>
                            ${ind.nama}
                        </h4>
                        <div class="space-y-3">
                `;
                
                ind.subs.forEach(sub => {
                    html += `
                        <div class="bg-white p-3 rounded-lg shadow-sm">
                            <div class="flex flex-col lg:flex-row lg:items-center gap-3">
                                <div class="flex-1">
                                    <label class="text-sm text-gray-600">
                                        <span class="font-medium text-blue-600">${sub.id}</span> - ${sub.nama}
                                    </label>
                                </div>
                                <div class="flex flex-wrap items-center gap-3">
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs text-gray-500 whitespace-nowrap">Data Input:</span>
                                        <input type="number" step="any" id="input_${sub.id}" 
                                            onchange="calculateForm()" oninput="calculateForm()"
                                            class="input-field w-28 px-3 py-2 border border-gray-300 rounded-lg text-right focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs text-gray-500 whitespace-nowrap">Pembanding:</span>
                                        <span id="pembanding_${sub.id}" class="text-sm font-medium text-gray-700 w-24 text-right">${formatNumber(dataPembanding[sub.id] || sub.pembanding)}</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs text-gray-500">Rasio:</span>
                                        <span id="rasio_${sub.id}" class="text-sm font-medium text-gray-700 w-16 text-right">-</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs text-gray-500">Skor:</span>
                                        <span id="skor_${sub.id}" class="score-badge bg-gray-200 text-gray-700 px-2 py-1 rounded font-bold">0</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs text-gray-500">Bobot:</span>
                                        <span class="text-sm font-medium text-gray-700">${sub.bobot}</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs text-gray-500">Nilai:</span>
                                        <span id="nilai_${sub.id}" class="score-badge bg-blue-100 text-blue-700 px-2 py-1 rounded font-bold">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function renderAdminDataPembanding() {
            const container = document.getElementById('adminDataPembanding');
            let html = '';
            
            INDICATORS.forEach(ind => {
                html += `
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="font-semibold text-gray-800 mb-3">
                            <span class="bg-blue-600 text-white text-sm px-2 py-1 rounded mr-2">${ind.no}</span>
                            ${ind.nama}
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                `;
                
                ind.subs.forEach(sub => {
                    html += `
                        <div class="bg-white p-3 rounded-lg shadow-sm">
                            <label class="block text-sm text-gray-600 mb-1">
                                <span class="font-medium text-blue-600">${sub.id}</span>
                            </label>
                            <p class="text-xs text-gray-500 mb-2">${sub.nama}</p>
                            <input type="number" step="any" id="admin_${sub.id}" 
                                value="${dataPembanding[sub.id] || sub.pembanding}"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-right focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ==================== FORM CALCULATIONS ====================
        function loadKecamatanData() {
            const kecamatan = document.getElementById('selectKecamatan').value;
            document.getElementById('currentKecamatan').textContent = kecamatan;
            
            const data = allKecamatanData[kecamatan];
            
            // Update pembanding displays
            INDICATORS.forEach(ind => {
                ind.subs.forEach(sub => {
                    const pembandingEl = document.getElementById(`pembanding_${sub.id}`);
                    if (pembandingEl) {
                        pembandingEl.textContent = formatNumber(dataPembanding[sub.id] || sub.pembanding);
                    }
                });
            });
            
            if (data && data.inputs) {
                // Load existing data
                INDICATORS.forEach(ind => {
                    ind.subs.forEach(sub => {
                        const input = document.getElementById(`input_${sub.id}`);
                        if (input && data.inputs[sub.id] !== undefined) {
                            input.value = data.inputs[sub.id];
                        } else if (input) {
                            input.value = '';
                        }
                    });
                });
                calculateForm();
            } else {
                resetForm(false);
            }
        }

        function calculateForm() {
            const kecamatan = document.getElementById('selectKecamatan').value;
            let totalNilai = 0;
            let totalBobot = 0;
            
            INDICATORS.forEach(ind => {
                ind.subs.forEach(sub => {
                    const input = document.getElementById(`input_${sub.id}`);
                    const inputValue = input ? parseFloat(input.value) || 0 : 0;
                    const pembanding = dataPembanding[sub.id] || sub.pembanding;
                    
                    let rasio = 0;
                    if (sub.type === 'ratio') {
                        rasio = pembanding > 0 ? (inputValue / pembanding) : 0;
                    } else {
                        rasio = inputValue;
                    }
                    
                    const skor = inputValue === 0 ? 0 : sub.skorFunc(rasio);
                    const nilai = skor * sub.bobot;
                    totalNilai += nilai;
                    totalBobot += sub.bobot;
                    
                    // Update display
                    const rasioEl = document.getElementById(`rasio_${sub.id}`);
                    const skorEl = document.getElementById(`skor_${sub.id}`);
                    const nilaiEl = document.getElementById(`nilai_${sub.id}`);
                    
                    if (rasioEl) rasioEl.textContent = sub.type === 'ratio' ? rasio.toFixed(3) : inputValue || '-';
                    if (skorEl) {
                        skorEl.textContent = skor;
                        skorEl.className = `score-badge px-2 py-1 rounded font-bold ${getSkorColor(skor)}`;
                    }
                    if (nilaiEl) {
                        nilaiEl.textContent = nilai;
                        nilaiEl.className = `score-badge px-2 py-1 rounded font-bold ${getNilaiColor(nilai, sub.bobot)}`;
                    }
                });
            });
            
            // Update totals
            document.getElementById('totalNilai').textContent = totalNilai.toFixed(0);
            document.getElementById('totalBobot').textContent = totalBobot;
            
            const statusEl = document.getElementById('statusKelayakan');
            if (totalNilai >= BATAS_LAYAK) {
                statusEl.textContent = 'LAYAK (Berkapasitas)';
                statusEl.className = 'px-6 py-3 rounded-lg text-white font-bold text-lg status-layak';
            } else {
                statusEl.textContent = 'TIDAK LAYAK (Tidak Berkapasitas)';
                statusEl.className = 'px-6 py-3 rounded-lg text-white font-bold text-lg status-tidak-layak';
            }
        }

        function getSkorColor(skor) {
            if (skor >= 5) return 'bg-green-500 text-white';
            if (skor >= 4) return 'bg-green-400 text-white';
            if (skor >= 3) return 'bg-yellow-400 text-gray-800';
            if (skor >= 2) return 'bg-orange-400 text-white';
            return 'bg-red-400 text-white';
        }

        function getNilaiColor(nilai, bobot) {
            const maxNilai = bobot * 5;
            const ratio = nilai / maxNilai;
            if (ratio >= 0.8) return 'bg-green-100 text-green-700';
            if (ratio >= 0.6) return 'bg-yellow-100 text-yellow-700';
            if (ratio >= 0.4) return 'bg-orange-100 text-orange-700';
            return 'bg-red-100 text-red-700';
        }

        async function saveData() {
            const kecamatan = document.getElementById('selectKecamatan').value;
            const inputs = {};
            
            INDICATORS.forEach(ind => {
                ind.subs.forEach(sub => {
                    const input = document.getElementById(`input_${sub.id}`);
                    if (input) {
                        inputs[sub.id] = parseFloat(input.value) || 0;
                    }
                });
            });
            
            try {
                // Show loading indicator in button if possible, or just toast
                showToast(`Menyimpan data ${kecamatan}...`, 'info');
                
                await calculateAndSave(kecamatan, inputs);
                await loadAllKecamatanData();
                updateDashboard();
                updateRekapTable();
                
                showToast(`Data ${kecamatan} berhasil disimpan!`);
            } catch (error) {
                console.error('Error saving data:', error);
                // Show specific error message from the thrown Error
                showToast(`Gagal: ${error.message || 'Terjadi kesalahan sistem'}`, 'error');
            }
        }

        function resetForm(showConfirm = true) {
            if (showConfirm && !confirm('Reset semua input form?')) return;
            
            const kecamatan = document.getElementById('selectKecamatan').value;
            
            INDICATORS.forEach(ind => {
                ind.subs.forEach(sub => {
                    const input = document.getElementById(`input_${sub.id}`);
                    if (input) input.value = '';
                    
                    const rasioEl = document.getElementById(`rasio_${sub.id}`);
                    const skorEl = document.getElementById(`skor_${sub.id}`);
                    const nilaiEl = document.getElementById(`nilai_${sub.id}`);
                    
                    if (rasioEl) rasioEl.textContent = '-';
                    if (skorEl) { skorEl.textContent = '0'; skorEl.className = 'score-badge bg-gray-200 text-gray-700 px-2 py-1 rounded font-bold'; }
                    if (nilaiEl) { nilaiEl.textContent = '0'; nilaiEl.className = 'score-badge bg-blue-100 text-blue-700 px-2 py-1 rounded font-bold'; }
                });
            });
            
            document.getElementById('totalNilai').textContent = '0';
            const statusEl = document.getElementById('statusKelayakan');
            statusEl.textContent = 'TIDAK LAYAK';
            statusEl.className = 'px-6 py-3 rounded-lg text-white font-bold text-lg status-tidak-layak';
            
            // Remove data from global state and refresh rekap table
            delete allKecamatanData[kecamatan];
            updateRekapTable();
            updateDashboard();
        }

        // ==================== DASHBOARD ====================
        function updateDashboard() {
            let sudahInput = 0;
            let layak = 0;
            let tidakLayak = 0;
            const nilaiPerKecamatan = [];
            
            KECAMATAN_LIST.forEach(kec => {
                const data = allKecamatanData[kec];
                if (data && data.totalNilai !== undefined) {
                    sudahInput++;
                    nilaiPerKecamatan.push({ nama: kec, nilai: data.totalNilai, status: data.status });
                    if (data.status === 'LAYAK') {
                        layak++;
                    } else {
                        tidakLayak++;
                    }
                } else {
                    nilaiPerKecamatan.push({ nama: kec, nilai: 0, status: 'Belum Input' });
                }
            });
            
            // Update stats
            document.getElementById('statSudahInput').textContent = sudahInput;
            document.getElementById('statLayak').textContent = layak;
            document.getElementById('statTidakLayak').textContent = tidakLayak;
            
            // Update kecamatan cards
            const cardsContainer = document.getElementById('kecamatanCards');
            cardsContainer.innerHTML = nilaiPerKecamatan.map(k => `
                <div class="bg-gray-50 rounded-lg p-4 card-hover cursor-pointer" onclick="openKecamatan('${k.nama}')">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-semibold text-gray-800">${k.nama}</h4>
                        <span class="text-xs px-2 py-1 rounded-full ${
                            k.status === 'LAYAK' ? 'bg-green-100 text-green-700' : 
                            k.status === 'TIDAK LAYAK' ? 'bg-red-100 text-red-700' : 
                            'bg-gray-200 text-gray-600'
                        }">${k.status}</span>
                    </div>
                    <p class="text-2xl font-bold ${k.nilai >= BATAS_LAYAK ? 'text-green-600' : 'text-gray-600'}">${k.nilai.toFixed(0)}</p>
                    <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                        <div class="h-2 rounded-full ${k.nilai >= BATAS_LAYAK ? 'bg-green-500' : 'bg-blue-500'}" 
                            style="width: ${Math.min(k.nilai / 500 * 100, 100)}%"></div>
                    </div>
                </div>
            `).join('');
            
            // Update charts
            updateCharts(nilaiPerKecamatan, layak, tidakLayak, KECAMATAN_LIST.length - sudahInput);
        }

        function updateCharts(nilaiData, layak, tidakLayak, belumInput) {
            // Bar chart
            const ctxBar = document.getElementById('chartKecamatan').getContext('2d');
            if (chartKecamatan) chartKecamatan.destroy();
            
            chartKecamatan = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: nilaiData.map(k => k.nama),
                    datasets: [{
                        label: 'Total Nilai',
                        data: nilaiData.map(k => k.nilai),
                        backgroundColor: nilaiData.map(k => 
                            k.nilai >= BATAS_LAYAK ? 'rgba(16, 185, 129, 0.7)' : 'rgba(59, 130, 246, 0.7)'
                        ),
                        borderColor: nilaiData.map(k => 
                            k.nilai >= BATAS_LAYAK ? 'rgb(16, 185, 129)' : 'rgb(59, 130, 246)'
                        ),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        annotation: {
                            annotations: {
                                line1: {
                                    type: 'line',
                                    yMin: BATAS_LAYAK,
                                    yMax: BATAS_LAYAK,
                                    borderColor: 'rgb(239, 68, 68)',
                                    borderWidth: 2,
                                    borderDash: [5, 5]
                                }
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, max: 500 }
                    }
                }
            });
            
            // Pie chart
            const ctxPie = document.getElementById('chartKelayakan').getContext('2d');
            if (chartKelayakan) chartKelayakan.destroy();
            
            chartKelayakan = new Chart(ctxPie, {
                type: 'doughnut',
                data: {
                    labels: ['LAYAK', 'TIDAK LAYAK', 'Belum Input'],
                    datasets: [{
                        data: [layak, tidakLayak, belumInput],
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(156, 163, 175, 0.8)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function openKecamatan(nama) {
            document.getElementById('selectKecamatan').value = nama;
            loadKecamatanData();
            showTab('form');
        }

        // ==================== REKAP TABLE ====================
        function updateRekapTable() {
            const tbody = document.getElementById('rekapTableBody');
            let html = '';
            
            KECAMATAN_LIST.forEach((kec, idx) => {
                const data = allKecamatanData[kec];
                const nilai = data ? data.totalNilai : 0;
                const status = data ? data.status : 'Belum Input';
                const lastUpdate = data ? formatDate(data.lastUpdate) : '-';
                
                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm text-gray-900">${idx + 1}</td>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${kec}</td>
                        <td class="px-4 py-3 text-sm text-center">
                            <span class="font-bold ${nilai >= BATAS_LAYAK ? 'text-green-600' : 'text-gray-600'}">${nilai.toFixed(0)}</span>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <span class="px-2 py-1 text-xs rounded-full ${
                                status === 'LAYAK' ? 'bg-green-100 text-green-700' : 
                                status === 'TIDAK LAYAK' ? 'bg-red-100 text-red-700' : 
                                'bg-gray-100 text-gray-600'
                            }">${status}</span>
                        </td>
                        <td class="px-4 py-3 text-sm text-center text-gray-500">${lastUpdate}</td>
                        <td class="px-4 py-3 text-center no-print">
                            <button onclick="openKecamatan('${kec}')" class="text-blue-600 hover:text-blue-800 mx-1" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteKecamatanData('${kec}')" class="text-red-600 hover:text-red-800 mx-1" title="Hapus">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        async function deleteKecamatanData(kecamatan) {
            if (!confirm(`Hapus data ${kecamatan}?`)) return;
            
            try {
                // Get kecamatan ID
                const { data: kecData, error: kecError } = await supabaseClient
                    .from('kecamatan')
                    .select('id')
                    .eq('nama', kecamatan)
                    .single();
                
                if (kecError) throw kecError;
                
                // Delete from database
                const { error } = await supabaseClient
                    .from('penilaian')
                    .delete()
                    .eq('kecamatan_id', kecData.id)
                    .eq('status', 'final');
                
                if (error) throw error;
                
                delete allKecamatanData[kecamatan];
                updateDashboard();
                updateRekapTable();
                
                if (document.getElementById('selectKecamatan').value === kecamatan) {
                    loadKecamatanData();
                }
                
                showToast(`Data ${kecamatan} berhasil dihapus!`);
            } catch (error) {
                console.error('Error deleting data:', error);
                showToast('Gagal menghapus data!', 'error');
            }
        }

        // ==================== EXPORT / IMPORT ====================
        function exportExcel() {
            const workbook = XLSX.utils.book_new();
            
            // Sheet 1: Rekap
            const rekapData = [
                ['No', 'Kecamatan', 'Total Nilai', 'Status', 'Terakhir Update']
            ];
            KECAMATAN_LIST.forEach((kec, idx) => {
                const data = allKecamatanData[kec];
                rekapData.push([
                    idx + 1,
                    kec,
                    data ? data.totalNilai : 0,
                    data ? data.status : 'Belum Input',
                    data ? formatDate(data.lastUpdate) : '-'
                ]);
            });
            const wsRekap = XLSX.utils.aoa_to_sheet(rekapData);
            XLSX.utils.book_append_sheet(workbook, wsRekap, 'Rekap');
            
            // Sheet 2: Detail per Kecamatan
            KECAMATAN_LIST.forEach(kec => {
                const data = allKecamatanData[kec];
                if (data && data.calculations) {
                    const detailData = [
                        ['No', 'Subindikator', 'Data Input', 'Data Pembanding', 'Rasio/Nilai', 'Skor', 'Bobot', 'Nilai']
                    ];
                    
                    let rowNum = 1;
                    INDICATORS.forEach(ind => {
                        ind.subs.forEach(sub => {
                            const calc = data.calculations[sub.id] || {};
                            detailData.push([
                                sub.id,
                                sub.nama,
                                calc.input || 0,
                                calc.pembanding || dataPembanding[sub.id] || sub.pembanding,
                                calc.rasio ? calc.rasio.toFixed(4) : 0,
                                calc.skor || 0,
                                sub.bobot,
                                calc.nilai || 0
                            ]);
                            rowNum++;
                        });
                    });
                    
                    detailData.push(['', '', '', '', '', '', 'TOTAL', data.totalNilai]);
                    detailData.push(['', '', '', '', '', '', 'STATUS', data.status]);
                    
                    const wsDetail = XLSX.utils.aoa_to_sheet(detailData);
                    XLSX.utils.book_append_sheet(workbook, wsDetail, kec.substring(0, 30));
                }
            });
            
            // Sheet 3: Data Pembanding
            const pembandingData = [
                ['Subindikator', 'Nama', 'Nilai Pembanding', 'Bobot']
            ];
            INDICATORS.forEach(ind => {
                ind.subs.forEach(sub => {
                    pembandingData.push([
                        sub.id,
                        sub.nama,
                        dataPembanding[sub.id] || sub.pembanding,
                        sub.bobot
                    ]);
                });
            });
            const wsPembanding = XLSX.utils.aoa_to_sheet(pembandingData);
            XLSX.utils.book_append_sheet(workbook, wsPembanding, 'Data Pembanding');
            
            XLSX.writeFile(workbook, `KAPASDA_Garut_Selatan_${formatDateFile(new Date())}.xlsx`);
            showToast('File Excel berhasil diexport!');
        }

        function importExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Try to import from each kecamatan sheet
                    let imported = 0;
                    workbook.SheetNames.forEach(sheetName => {
                        if (sheetName !== 'Rekap' && sheetName !== 'Data Pembanding') {
                            const kecamatan = KECAMATAN_LIST.find(k => sheetName.startsWith(k));
                            if (kecamatan) {
                                const worksheet = workbook.Sheets[sheetName];
                                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                                
                                const inputs = {};
                                jsonData.slice(1).forEach(row => {
                                    if (row[0] && row[2] !== undefined) {
                                        inputs[row[0]] = parseFloat(row[2]) || 0;
                                    }
                                });
                                
                                if (Object.keys(inputs).length > 0) {
                                    calculateAndSave(kecamatan, inputs);
                                    imported++;
                                }
                            }
                        }
                    });
                    
                    if (imported > 0) {
                        updateDashboard();
                        updateRekapTable();
                        loadKecamatanData();
                        showToast(`${imported} data kecamatan berhasil diimport!`);
                    } else {
                        showToast('Tidak ada data yang bisa diimport. Pastikan format file sesuai.', 'error');
                    }
                } catch (err) {
                    console.error(err);
                    showToast('Gagal membaca file Excel!', 'error');
                }
            };
            reader.readAsArrayBuffer(file);
            event.target.value = '';
        }

        function exportAllData() {
            const exportData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                dataPembanding: dataPembanding,
                allKecamatanData: allKecamatanData
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `KAPASDA_Backup_${formatDateFile(new Date())}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Backup data berhasil!');
        }

        function importAllData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!confirm('Import data akan menimpa semua data yang ada. Lanjutkan?')) {
                event.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    if (importData.dataPembanding) {
                        dataPembanding = importData.dataPembanding;
                        localStorage.setItem('kapasda_pembanding', JSON.stringify(dataPembanding));
                    }
                    
                    if (importData.allKecamatanData) {
                        allKecamatanData = importData.allKecamatanData;
                        saveAllKecamatanData();
                    }
                    
                    renderAdminDataPembanding();
                    updateDashboard();
                    updateRekapTable();
                    loadKecamatanData();
                    showToast('Data berhasil direstore!');
                } catch (err) {
                    console.error(err);
                    showToast('Gagal membaca file backup!', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        async function clearAllData() {
            if (userRole !== 'admin') {
                showToast('Hanya admin yang dapat menghapus semua data!', 'error');
                return;
            }
            
            if (!confirm('PERINGATAN: Semua data kecamatan akan dihapus permanen. Lanjutkan?')) return;
            if (!confirm('Apakah Anda yakin? Tindakan ini tidak dapat dibatalkan!')) return;
            
            try {
                const { error } = await supabaseClient
                    .from('penilaian')
                    .delete()
                    .eq('status', 'final');
                
                if (error) throw error;
                
                allKecamatanData = {};
                updateDashboard();
                updateRekapTable();
                loadKecamatanData();
                showToast('Semua data berhasil dihapus!');
            } catch (error) {
                console.error('Error clearing all data:', error);
                showToast('Gagal menghapus semua data!', 'error');
            }
        }

        async function deleteIncorrectRecords() {
            try {
                // Get all penilaian records
                const { data, error } = await supabaseClient
                    .from('penilaian')
                    .select('*')
                    .eq('status', 'final');
                
                if (error) throw error;
                
                let deletedCount = 0;
                
                for (const record of data) {
                    const jsonData = record.data;
                    if (jsonData && jsonData.inputs) {
                        // Check if all inputs are 0 but total_nilai is not 0
                        const allInputsZero = Object.values(jsonData.inputs).every(val => val === 0);
                        const hasNonZeroScore = record.total_nilai !== 0;
                        
                        if (allInputsZero && hasNonZeroScore) {
                            console.log(`Found incorrect record for kecamatan_id ${record.kecamatan_id}: all inputs 0 but score ${record.total_nilai}`);
                            
                            // Delete the incorrect record
                            const { error: deleteError } = await supabaseClient
                                .from('penilaian')
                                .delete()
                                .eq('kecamatan_id', record.kecamatan_id)
                                .eq('status', 'final');
                            
                            if (!deleteError) {
                                deletedCount++;
                                console.log(`Deleted incorrect record for kecamatan_id ${record.kecamatan_id}`);
                            }
                        }
                    }
                }
                
                if (deletedCount > 0) {
                    showToast(`${deletedCount} records with incorrect calculations deleted!`);
                    // Refresh data
                    await loadAllKecamatanData();
                    updateDashboard();
                    updateRekapTable();
                } else {
                    showToast('No incorrect records found.');
                }
                
                return deletedCount;
            } catch (error) {
                console.error('Error cleaning up incorrect records:', error);
                showToast('Error cleaning up records!', 'error');
                return 0;
            }
        }

        // ==================== UTILITIES ====================
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active');
            
            // Find and activate the corresponding nav tab button
            const tabButton = document.querySelector(`[onclick="showTab('${tabId}')"]`);
            if (tabButton) {
                tabButton.classList.add('active');
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 z-50 ${
                type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'
            }`;
            
            toast.classList.remove('translate-y-20', 'opacity-0');
            
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        function formatNumber(num) {
            if (num === undefined || num === null) return '-';
            if (num >= 1000000000) return (num / 1000000000).toFixed(2) + ' M';
            if (num >= 1000000) return (num / 1000000).toFixed(2) + ' Jt';
            if (num >= 1000) return num.toLocaleString('id-ID');
            return num.toString();
        }

        function formatDate(isoString) {
            if (!isoString) return '-';
            const date = new Date(isoString);
            return date.toLocaleDateString('id-ID', { 
                day: '2-digit', month: 'short', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        }

        function formatDateFile(date) {
            return date.toISOString().slice(0, 10).replace(/-/g, '');
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', init);
    </script>

</body>
</html>